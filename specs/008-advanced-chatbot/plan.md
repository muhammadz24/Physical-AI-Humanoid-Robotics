# Implementation Plan: Advanced Chatbot with History Management

**Branch**: `008-advanced-chatbot` | **Date**: 2025-12-16 | **Spec**: [spec.md](./spec.md)

## Summary

Overhaul existing chatbot with comprehensive history management. Guest users store temporary chat history in browser sessionStorage (survives refresh, clears on tab close). Authenticated users store permanent history in Postgres database. On login, guest session history automatically synchronizes to user's database. Add privacy controls: "Delete All History" and configurable "Auto-Delete (X Days)" settings. Modernize UI with cleaner design, better message bubbles, typing indicators, and scroll-to-bottom functionality.

## Technical Context

**Language/Version**: Python 3.11 (backend), JavaScript/React (frontend with Docusaurus v3)
**Primary Dependencies**: FastAPI, Neon Postgres, React, browser sessionStorage API
**Storage**: Dual-tier (sessionStorage for guests, Postgres for authenticated users)
**Testing**: pytest (backend), Jest (frontend), manual testing
**Target Platform**: Web application
**Project Type**: Web (backend + frontend)
**Performance Goals**: History loads in <1s, sync completes in <3s, delete instant (<1s UX)
**Constraints**: Free-tier Postgres storage, sessionStorage ~5-10MB limit
**Scale/Scope**: POC with all 6 user stories

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Principle I (Simplicity-First)**: Chat history is essential for usable chatbot UX
✅ **Principle III (Free-Tier)**: Uses Neon Postgres free tier, browser storage (free)
✅ **Principle IV (Docusaurus Best Practices)**: Chat widget follows Docusaurus component patterns
✅ **Principle V (Minimalism)**: No new dependencies (uses existing database, React hooks)
✅ **Principle IX (Zero-Edit Deployment)**: Uses existing DATABASE_URL environment variable

**No violations** - all principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/008-advanced-chatbot/
├── plan.md              # This file
├── research.md          # Phase 0: Storage strategies, sync patterns
├── data-model.md        # Phase 1: chat_messages schema, API models
├── quickstart.md        # Phase 1: Setup and testing guide
├── contracts/           # Phase 1: API contracts
│   └── chat-history-api.yaml
└── tasks.md             # Phase 2: Generated by /sp.tasks
```

### Source Code (repository root)

```text
backend/
├── app/
│   ├── api/
│   │   └── chat.py              # MODIFY: Add history endpoints (GET, DELETE)
│   ├── services/
│   │   └── chat_service.py      # MODIFY: Add history retrieval/deletion
│   └── models/
│       └── chat.py              # NEW: ChatMessage model
├── migrations/
│   └── 002_create_chat_messages.sql  # NEW: Database migration
└── jobs/
    └── cleanup_old_messages.py  # NEW: Auto-delete background job

frontend/src/
├── components/
│   ├── ChatWidget/              # MODIFY: Overhaul UI, add history management
│   │   ├── index.js            # MODIFY: New UI components
│   │   ├── ChatHistory.js      # NEW: History display component
│   │   ├── ChatMessage.js      # NEW: Message bubble component
│   │   ├── useSessionStorage.js # NEW: Hook for guest storage
│   │   └── useChatHistory.js   # NEW: Hook for user history
│   └── ChatSettings/            # NEW: Settings modal (delete, auto-delete)
│       └── index.js
└── utils/
    └── syncGuestHistory.js      # NEW: Guest→User sync utility
```

**Structure Decision**: Web application with dual storage tiers. Existing chat backend extended with history endpoints. Frontend chat widget completely overhauled with modern UI components.

## Complexity Tracking

No violations to justify - feature aligns with all constitutional principles.

## Phase 0: Research

See [research.md](./research.md) for detailed findings on:
- sessionStorage vs localStorage tradeoffs
- Guest→User synchronization strategies
- Database indexing for efficient history queries
- Background job scheduling options (APScheduler vs Celery)
- UI component architecture for message display

## Phase 1: Design

### Data Model

See [data-model.md](./data-model.md) for:
- chat_messages table schema (id, user_id, role, content, timestamp, session_id)
- ChatMessage Pydantic model
- ChatHistoryResponse model
- UserSettings extension (auto_delete_enabled, auto_delete_days)

### API Contracts

See [contracts/chat-history-api.yaml](./contracts/chat-history-api.yaml) for:
- GET /api/chat/history - Retrieve user's chat history
- DELETE /api/chat/history - Delete all user chat history
- POST /api/chat - Modified to save to database for authenticated users
- POST /api/chat/sync - Sync guest history to user account on login

### Quickstart

See [quickstart.md](./quickstart.md) for:
- Development environment setup
- Testing guest sessionStorage flow
- Testing authenticated user database flow
- Testing guest→user synchronization
- Testing delete and auto-delete features

## Implementation Approach

### Backend

1. **Database Migration** (`migrations/002_create_chat_messages.sql`):
   - Create chat_messages table with fields: id (UUID), user_id (UUID nullable), session_id (UUID nullable), role (user/assistant), content (TEXT), timestamp (TIMESTAMP), created_at
   - Index on user_id for fast user history retrieval
   - Index on timestamp for auto-delete queries

2. **ChatMessage Model** (`models/chat.py`):
   - Pydantic models: ChatMessage, ChatHistoryResponse, SyncGuestHistoryRequest
   - Validation: content length, role enum (user|assistant)

3. **Chat Service Extensions** (`services/chat_service.py`):
   - save_message(user_id, role, content, session_id=None) - Save to database
   - get_user_history(user_id, limit=100) - Retrieve with pagination
   - delete_user_history(user_id) - Bulk delete
   - sync_guest_messages(user_id, guest_messages) - Atomic sync transaction

4. **History API Endpoints** (`api/chat.py`):
   - GET /api/chat/history - Requires auth, returns user's messages
   - DELETE /api/chat/history - Requires auth, deletes all user messages
   - POST /api/chat/sync - Requires auth, syncs guest history from request body
   - POST /api/chat - Modified to save authenticated user messages to database

5. **Auto-Delete Background Job** (`jobs/cleanup_old_messages.py`):
   - Query users with auto_delete_enabled=true
   - For each user, delete messages older than auto_delete_days
   - Schedule with APScheduler (run daily at 2 AM UTC)
   - Log deletions for monitoring

### Frontend

1. **sessionStorage Management** (`useSessionStorage.js` hook):
   - Save guest messages with key: `chatbot_history_guest`
   - Load on component mount
   - Clear on logout or sync

2. **Chat History Hook** (`useChatHistory.js`):
   - For authenticated: Fetch from GET /api/chat/history on mount
   - For guests: Load from sessionStorage
   - Unified interface: addMessage(message), clearHistory()

3. **Guest→User Sync** (`syncGuestHistory.js` utility):
   - Triggered on successful signin/signup (listen to AuthProvider)
   - Read sessionStorage guest history
   - POST /api/chat/sync with guest messages
   - Clear sessionStorage on success
   - Handle errors gracefully (keep guest history if sync fails)

4. **UI Overhaul** (`ChatWidget/index.js`):
   - Modern message bubbles (user right-aligned, assistant left-aligned)
   - Typing indicator animation during LLM response
   - Auto-scroll to bottom on new messages
   - Scroll-to-bottom button when user scrolls up
   - Timestamp display (relative: "2 minutes ago")

5. **Chat Settings Modal** (`ChatSettings/index.js`):
   - "Delete All History" button with confirmation dialog
   - "Auto-Delete" toggle with days selector (7, 30, 90, disabled)
   - Save settings to backend /api/user/settings

### Testing Strategy

**Backend**:
- Unit tests for save_message, get_user_history, delete_user_history
- Integration test for guest→user sync (atomic transaction)
- Test auto-delete job with mock dates
- Test API endpoints with authentication

**Frontend**:
- Component tests for ChatMessage, ChatHistory
- Hook tests for useSessionStorage, useChatHistory
- Integration test for full chat flow (send, save, retrieve)
- Test sessionStorage persistence across page refresh

**Manual Testing**:
- Test as guest: Send messages, refresh page, verify persistence, close tab, verify cleared
- Test as user: Send messages, logout, login, verify history restored
- Test sync: Use as guest, login, verify history merged
- Test delete: Click "Delete All History", verify database cleared
- Test auto-delete: Set to 7 days, run job manually, verify old messages deleted

## Security Considerations

- **Guest history isolation**: sessionStorage is per-origin, but use unique session_id to prevent conflicts
- **Authentication enforcement**: History endpoints require valid JWT
- **Input validation**: Sanitize message content before storing
- **Sync transaction safety**: Use database transactions to ensure atomicity
- **Rate limiting**: Consider limiting message send rate (prevent spam)

## Deployment Notes

- **Database migration**: Run 002_create_chat_messages.sql before deploying
- **Background job**: Deploy cleanup_old_messages.py, configure scheduler (e.g., systemd timer or cron)
- **Environment variables**: No new vars required (uses existing DATABASE_URL)
- **Backward compatibility**: Existing chat functionality remains intact, history is additive

## Future Enhancements (Out of Scope)

- Search within chat history
- Export history as PDF/JSON
- Conversation threading/sessions
- Message editing/deletion (individual messages)
- Undo delete (grace period)
- Multi-device real-time sync
- Message attachments (images, files)

## Phase 2: Task Generation

Use `/sp.tasks` command to generate tasks.md from this plan and the specification.

## Artifacts

- [x] plan.md (this file)
- [ ] research.md (Phase 0)
- [ ] data-model.md (Phase 1)
- [ ] contracts/chat-history-api.yaml (Phase 1)
- [ ] quickstart.md (Phase 1)
- [ ] tasks.md (Phase 2 - run /sp.tasks)
